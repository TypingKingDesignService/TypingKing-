<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing King - Design & Editing Service</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --primary-light: #6366f1; /* Indigo 500 */
            --secondary: #10b981; /* Emerald 500 */
            --background: #f8fafc; /* Slate 50 */
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar for chat */
        #chat-messages {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* New messages at the bottom */
        }
        
        .chat-container::-webkit-scrollbar { width: 8px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: var(--primary-light); border-radius: 10px; }
        .chat-container::-webkit-scrollbar-track { background-color: var(--card-bg); }

        .call-button {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .call-button:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="p-4 sm:p-6 pb-20">

    <div id="loading-screen" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex items-center justify-center hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
            <p class="mt-4 text-indigo-600 font-semibold">Loading App...</p>
        </div>
    </div>
    
    <header class="text-center py-6 bg-white shadow-lg rounded-2xl mb-6 sticky top-0 z-10">
        <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Typing King</h1>
        <p class="text-sm text-indigo-600 mt-1">Typography, Editing & Design Services</p>
    </header>

    <main id="app-container" class="max-w-4xl mx-auto space-y-8">
        
        <!-- Global Message Box (used instead of alert/confirm) -->
        <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 rounded-xl shadow-2xl transition-opacity duration-300 opacity-0 pointer-events-none text-white font-medium" role="alert"></div>

        <!-- Section 1: Customer Information -->
        <section class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-indigo-500">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                Customer Details
            </h2>
            <div class="space-y-4">
                <div>
                    <label for="employerName" class="block text-sm font-medium text-gray-700">Your Name (Employer Name)</label>
                    <input type="text" id="employerName" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., John Doe">
                </div>
                <div>
                    <label for="contactNumber" class="block text-sm font-medium text-gray-700">Contact Number</label>
                    <input type="tel" id="contactNumber" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 09xxxxxxxxx">
                </div>
                <p id="userIdDisplay" class="text-xs text-gray-500 mt-2 p-2 bg-gray-100 rounded-lg">Your unique user ID (for chat/order tracking): <span id="userIdValue" class="font-mono text-gray-700">...</span></p>
            </div>
        </section>

        <!-- Section 2: Service Selection (Tabs) -->
        <section class="bg-white p-6 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v13.663C12 18.064 10.518 19.5 8.784 19.5H6a2.25 2.25 0 01-2.25-2.25v-10.5A2.25 2.25 0 016 4.5h3.663"></path></svg>
                Select Your Service
            </h2>

            <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                <button onclick="showSection('typing')" class="tab-button active:scale-95 transition px-4 py-2 text-sm font-semibold rounded-full bg-indigo-600 text-white shadow-md hover:bg-indigo-700" data-section="typing">Typing & Editing</button>
                <button onclick="showSection('design')" class="tab-button active:scale-95 transition px-4 py-2 text-sm font-semibold rounded-full bg-gray-200 text-gray-700 hover:bg-indigo-100" data-section="design">Graphic Design</button>
                <button onclick="showSection('photo')" class="tab-button active:scale-95 transition px-4 py-2 text-sm font-semibold rounded-full bg-gray-200 text-gray-700 hover:bg-indigo-100" data-section="photo">Photo Restoration</button>
            </div>

            <div id="service-forms-container" class="space-y-6">
                <!-- Typing Form -->
                <div id="typing-section" class="service-section space-y-4">
                    <h3 class="text-xl font-semibold text-indigo-700">Typing & Editing Service</h3>
                    <!-- Size Selection -->
                    <label class="block text-sm font-medium text-gray-700">Paper Size</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="radio-label"><input type="radio" name="typingSize" value="A4" checked> A4</label>
                        <label class="radio-label"><input type="radio" name="typingSize" value="LETTER"> Letter</label>
                        <label class="radio-label"><input type="radio" name="typingSize" value="LEGAL"> Legal</label>
                    </div>

                    <!-- Color Selection -->
                    <label class="block text-sm font-medium text-gray-700 pt-2">Color Option</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="radio-label"><input type="radio" name="typingColor" value="B/W" checked> Black & White</label>
                        <label class="radio-label"><input type="radio" name="typingColor" value="Color"> Color</label>
                    </div>
                </div>

                <!-- Design Form -->
                <div id="design-section" class="service-section space-y-4 hidden">
                    <h3 class="text-xl font-semibold text-indigo-700">Graphic Design Service</h3>
                    
                    <!-- Design Type -->
                    <label class="block text-sm font-medium text-gray-700">Design Type</label>
                    <select id="designType" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="Logo">Logo</option>
                        <option value="Social Media Design">Social Media Design</option>
                        <option value="Bill Board Design">Bill Board Design (Custom Size)</option>
                        <option value="Vinyl Design">Vinyl (Custom Size)</option>
                        <option value="Business Card">Business Card</option>
                        <option value="Invitation Card">Invitation Card</option>
                        <option value="Birthday Card">Birthday Card</option>
                        <option value="Certificate">Certificate</option>
                    </select>

                    <!-- Design Size -->
                    <label class="block text-sm font-medium text-gray-700 pt-2">Size Specification</label>
                    <select id="designSize" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="A4">A4</option>
                        <option value="A5">A5</option>
                        <option value="Legal">Legal</option>
                        <option value="4x6">4 x 6 (Inches)</option>
                        <option value="A4-4cho">A4-4 cho</option>
                        <option value="Legal-4cho">Legal-4 cho</option>
                        <option value="Custom">Custom Size (for Bill Board/Vinyl)</option>
                        <option value="SocialMedia">Social Media Standard Sizes</option>
                    </select>
                    
                    <!-- Custom Size Input (for Vinyl/Bill Board) -->
                    <div id="customSizeInput" class="hidden pt-2">
                        <label for="customSize" class="block text-sm font-medium text-gray-700">Enter Custom/Social Media Size Details (e.g., 10x20 ft, FB Cover Photo)</label>
                        <input type="text" id="customSize" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 10x20 ft (Bill Board)">
                    </div>

                    <!-- Color Selection -->
                    <label class="block text-sm font-medium text-gray-700 pt-2">Color Option</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="radio-label"><input type="radio" name="designColor" value="B/W" checked> Black & White</label>
                        <label class="radio-label"><input type="radio" name="designColor" value="Color"> Color</label>
                    </div>
                </div>

                <!-- Photo Form -->
                <div id="photo-section" class="service-section space-y-4 hidden">
                    <h3 class="text-xl font-semibold text-indigo-700">Photo Editing Service</h3>
                    
                    <!-- Photo Type -->
                    <label class="block text-sm font-medium text-gray-700">Photo Task</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="radio-label"><input type="radio" name="photoType" value="Old Restoration" checked> Old Photo Restoration</label>
                        <label class="radio-label"><input type="radio" name="photoType" value="Change Background"> Change Background</label>
                        <label class="radio-label"><input type="radio" name="photoType" value="Retouching"> Retouching</label>
                    </div>

                    <!-- Color Selection -->
                    <label class="block text-sm font-medium text-gray-700 pt-2">Color Option</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="radio-label"><input type="radio" name="photoColor" value="B/W" checked> Black & White</label>
                        <label class="radio-label"><input type="radio" name="photoColor" value="Color"> Color</label>
                    </div>
                </div>

                <!-- Shared: Image Upload -->
                <div class="pt-4 border-t">
                    <label for="imageUpload" class="block text-sm font-medium text-gray-700">Upload Reference Image / File</label>
                    <input type="file" id="imageUpload" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <p class="text-xs text-gray-500 mt-1">This is a mockup upload. Actual file handling requires a server, but the app will log the intent.</p>
                </div>
                
                <!-- Shared: Details (NOW SEPARATED) -->
                <div class="pt-4 border-t space-y-4">
                    <label for="orderDetails" class="block text-sm font-medium text-gray-700">Detailed Work Description (Required)</label>
                    <textarea id="orderDetails" rows="4" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., I need 5 pages typed. Use a professional font like Times New Roman."></textarea>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="timeFrame" class="block text-sm font-medium text-gray-700">Required Time Frame (e.g., Deadline)</label>
                            <input type="text" id="timeFrame" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., Tomorrow 5 PM, 3 days from now">
                        </div>
                        <div>
                            <label for="budget" class="block text-sm font-medium text-gray-700">Budget / Agreed Price (MMK)</label>
                            <input type="text" id="budget" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 10,000 MMK, Negotiable">
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Section 3: Deposit & Payment -->
        <section class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-secondary">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                Deposit & Payment Confirmation
            </h2>
            
            <div class="p-4 bg-yellow-50 rounded-lg mb-4 border border-yellow-200">
                <p class="text-sm font-semibold text-yellow-800 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.427 2.605-1.427 3.37 0l4.724 8.797c.563 1.048-.112 2.302-1.285 2.302H4.78c-1.173 0-1.848-1.254-1.285-2.302l4.724-8.797zM12 9a1 1 0 10-2 0v3a1 1 0 102 0V9zm-1 7a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>
                    CRITICAL: A deposit must be reserved (confirmed) before submitting the job.
                </p>
            </div>

            <!-- Transfer Details -->
            <div class="space-y-4 mb-6 p-4 bg-gray-100 rounded-lg">
                <h4 class="font-semibold text-gray-700">Money Transfer Details:</h4>
                <p class="text-sm">
                    **K-Pay or Wave Pay:** <span class="font-mono text-indigo-600">09451119591</span><br>
                    **Account Holder:** <span class="font-semibold">U Sai Khant Aung</span>
                </p>
            </div>
            
            <!-- Deposit Status -->
            <div class="flex items-center space-x-3 mb-6">
                <input id="depositPaid" type="checkbox" class="w-5 h-5 text-secondary border-gray-300 rounded focus:ring-secondary-500">
                <label for="depositPaid" class="text-lg font-bold text-gray-800">I have paid the deposit (or will pay upon agreement).</label>
            </div>

            <div id="receiptFields" class="space-y-4 p-4 border rounded-lg hidden bg-white">
                <div>
                    <label for="receiptUpload" class="block text-sm font-medium text-gray-700">Upload Receipt Photo</label>
                    <input type="file" id="receiptUpload" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-secondary-50 file:text-secondary-700 hover:file:bg-secondary-100">
                </div>
                <div>
                    <label for="lastSixDigits" class="block text-sm font-medium text-gray-700">Last 6 Digits of Receipt</label>
                    <input type="text" id="lastSixDigits" maxlength="6" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-secondary-500 focus:ring-secondary-500" placeholder="Enter last 6 digits for verification">
                </div>
            </div>

            <button id="submitOrderBtn" class="w-full mt-6 px-4 py-4 bg-indigo-600 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-indigo-700 transition active:scale-95">
                Submit Job & Request Quote
            </button>
        </section>

        <!-- Section 4: Admin Contact -->
        <section class="bg-white p-6 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                Contact Admin (Call)
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <!-- Phone 1 -->
                <a href="tel:09451119591" class="call-button flex items-center justify-center p-3 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                    09451119591
                </a>
                <!-- Phone 2 -->
                <a href="tel:09987564733" class="call-button flex items-center justify-center p-3 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                    09987564733
                </a>
                <!-- Phone 3 -->
                <a href="tel:09778458554" class="call-button flex items-center justify-center p-3 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                    09778458554
                </a>
            </div>
        </section>


        <!-- Section 5: Real-Time Chat Room (Firestore) -->
        <section class="bg-white p-6 rounded-2xl shadow-2xl border-t-4 border-indigo-700">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z"></path></svg>
                Real-Time Chat with Admin
            </h2>
            <div id="chat-status" class="text-sm text-center py-2 text-red-500 italic">Chat loading...</div>

            <div id="chat-messages" class="chat-container border rounded-lg p-3 bg-gray-50 h-96 mb-4 flex flex-col-reverse space-y-2 overflow-y-auto">
                <!-- Messages will be injected here (in reverse order) -->
                <p class="text-center text-gray-400 text-sm py-8">Start a conversation with the Typing King Admin!</p>
            </div>

            <div class="flex space-x-2">
                <input type="text" id="chatInput" class="flex-grow rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Type your message here...">
                <button id="sendChatBtn" class="px-4 py-3 bg-indigo-600 text-white rounded-lg font-semibold shadow-md hover:bg-indigo-700 active:scale-95 transition">
                    Send
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Chat is automatically linked to your unique user ID above.</p>
        </section>

    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP & FIREBASE INIT ---

        // Firebase Globals (Provided by Environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'typing-king-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        setLogLevel('Debug'); // Enable debug logging for Firebase

        const loadingScreen = document.getElementById('loading-screen');
        loadingScreen.classList.remove('hidden');

        // Custom Message Box
        function showMessage(message, type = 'success', duration = 3000) {
            const box = document.getElementById('message-box');
            let color = '';
            if (type === 'success') {
                color = 'bg-green-500';
            } else if (type === 'error') {
                color = 'bg-red-500';
            } else {
                color = 'bg-blue-500';
            }
            
            box.textContent = message;
            box.className = `fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 rounded-xl shadow-2xl transition-opacity duration-300 ${color} text-white font-medium`;
            box.style.opacity = '1';
            box.style.pointerEvents = 'auto';

            setTimeout(() => {
                box.style.opacity = '0';
                box.style.pointerEvents = 'none';
            }, duration);
        }

        // 1. Initialize Firebase and Auth
        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in logic
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('userIdValue').textContent = currentUserId;
                        isAuthReady = true;
                        console.log("Firebase Auth State: Signed in as", currentUserId);
                        // Start listeners after auth is ready
                        setupChatListener(db);
                    } else {
                        // Attempt silent sign-in if token is available
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Anonymous sign-in if no token is available
                            await signInAnonymously(auth);
                        }
                    }
                    loadingScreen.classList.add('hidden');
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage("Error initializing services. See console for details.", 'error', 5000);
                loadingScreen.classList.add('hidden');
            }
        } else {
            console.warn("Firebase config not available. Chat/Persistence will be disabled.");
            document.getElementById('chat-status').textContent = "Offline Mode: Cannot connect to chat/database.";
            loadingScreen.classList.add('hidden');
            isAuthReady = true;
            currentUserId = crypto.randomUUID();
            document.getElementById('userIdValue').textContent = currentUserId + ' (Offline)';
        }


        // --- CHAT FUNCTIONALITY ---

        const chatMessagesEl = document.getElementById('chat-messages');
        const chatInputEl = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');

        function setupChatListener(db) {
            if (!isAuthReady || !currentUserId || !db) return;
            
            const chatPath = `/artifacts/${appId}/public/data/chat_messages`;
            const q = query(collection(db, chatPath), orderBy("timestamp", "desc")); // Fetch descending for display

            document.getElementById('chat-status').textContent = "Connected. Real-time chat active.";
            document.getElementById('chat-status').classList.remove('text-red-500');
            document.getElementById('chat-status').classList.add('text-green-600');


            onSnapshot(q, (snapshot) => {
                chatMessagesEl.innerHTML = ''; // Clear existing messages
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const isSender = msg.userId === currentUserId;
                    const date = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';
                    
                    const messageEl = document.createElement('div');
                    messageEl.className = `flex ${isSender ? 'justify-end' : 'justify-start'}`;
                    messageEl.innerHTML = `
                        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-xl shadow ${isSender ? 'bg-indigo-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'}">
                            <p class="text-xs font-bold ${isSender ? 'text-indigo-200' : 'text-gray-500'}">${isSender ? 'You' : (msg.userName || 'Admin')}</p>
                            <p class="mt-1">${msg.text}</p>
                            <span class="block text-right text-xs pt-1 ${isSender ? 'text-indigo-300' : 'text-gray-500'}">${date}</span>
                        </div>
                    `;
                    chatMessagesEl.appendChild(messageEl);
                });
            }, (error) => {
                console.error("Error setting up chat listener:", error);
                document.getElementById('chat-status').textContent = "Error: Chat connection failed.";
                document.getElementById('chat-status').classList.remove('text-green-600');
                document.getElementById('chat-status').classList.add('text-red-500');
            });
        }

        async function sendChatMessage() {
            if (!isAuthReady || !db) {
                showMessage("Chat is not yet connected to the database. Please wait or check connection.", 'error');
                return;
            }

            const text = chatInputEl.value.trim();
            if (text === "") return;
            
            const userName = document.getElementById('employerName').value.trim() || 'Anonymous User';

            try {
                const chatPath = `/artifacts/${appId}/public/data/chat_messages`;
                await addDoc(collection(db, chatPath), {
                    userId: currentUserId,
                    userName: userName,
                    text: text,
                    timestamp: serverTimestamp()
                });

                chatInputEl.value = '';
                showMessage("Message sent!", 'success', 1500);

            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Failed to send message.", 'error');
            }
        }

        // Event listeners for chat
        sendChatBtn.addEventListener('click', sendChatMessage);
        chatInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });


        // --- FORM LOGIC & UI MANAGEMENT ---

        const depositPaidEl = document.getElementById('depositPaid');
        const receiptFieldsEl = document.getElementById('receiptFields');
        const designSizeEl = document.getElementById('designSize');
        const customSizeInputEl = document.getElementById('customSizeInput');
        const submitOrderBtn = document.getElementById('submitOrderBtn');
        let currentSection = 'typing';

        // Toggles visibility of receipt fields
        depositPaidEl.addEventListener('change', () => {
            receiptFieldsEl.classList.toggle('hidden', !depositPaidEl.checked);
        });

        // Toggles visibility of custom size input for Design section
        designSizeEl.addEventListener('change', () => {
            const value = designSizeEl.value;
            const needsCustom = value === 'Custom' || value === 'SocialMedia';
            customSizeInputEl.classList.toggle('hidden', !needsCustom);
        });

        // Tab Switching Logic
        window.showSection = function(sectionId) {
            currentSection = sectionId;
            document.querySelectorAll('.service-section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById(`${sectionId}-section`).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.getAttribute('data-section') === sectionId) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-indigo-100');
                    btn.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                } else {
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-indigo-100');
                    btn.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                }
            });
        }


        // Submission Logic
        submitOrderBtn.addEventListener('click', () => {
            const employerName = document.getElementById('employerName').value.trim();
            const contactNumber = document.getElementById('contactNumber').value.trim();
            const orderDetails = document.getElementById('orderDetails').value.trim();
            // NEW FIELDS CAPTURED HERE
            const timeFrame = document.getElementById('timeFrame').value.trim();
            const budget = document.getElementById('budget').value.trim();
            
            const depositPaid = depositPaidEl.checked;
            const lastSixDigits = document.getElementById('lastSixDigits').value.trim();
            
            // 1. Basic Validation (Updated for new fields)
            if (!employerName || !contactNumber || !orderDetails || !timeFrame || !budget) {
                showMessage("Please fill in your Name, Contact Number, **Detailed Work Description**, **Time Frame**, and **Budget**.", 'error', 4000);
                return;
            }

            // 2. Deposit/Payment Validation
            if (!depositPaid) {
                showMessage("A deposit must be reserved (check the box) before a job request can be submitted. Please arrange payment first.", 'error', 6000);
                return;
            }
            
            if (depositPaid && lastSixDigits.length !== 6) {
                showMessage("Please enter the last 6 digits of the receipt for verification.", 'error', 4000);
                return;
            }

            // 3. Collect Service-Specific Data
            let serviceData = {
                type: currentSection,
                details: {}
            };

            if (currentSection === 'typing') {
                serviceData.details = {
                    size: document.querySelector('input[name="typingSize"]:checked')?.value || 'N/A',
                    color: document.querySelector('input[name="typingColor"]:checked')?.value || 'N/A',
                };
            } else if (currentSection === 'design') {
                const designSize = designSizeEl.value;
                serviceData.details = {
                    designType: document.getElementById('designType').value,
                    color: document.querySelector('input[name="designColor"]:checked')?.value || 'N/A',
                    size: designSize,
                    customSize: (designSize === 'Custom' || designSize === 'SocialMedia') ? document.getElementById('customSize').value.trim() : 'N/A'
                };
            } else if (currentSection === 'photo') {
                serviceData.details = {
                    task: document.querySelector('input[name="photoType"]:checked')?.value || 'N/A',
                    color: document.querySelector('input[name="photoColor"]:checked')?.value || 'N/A',
                };
            }

            // 4. Final Order Object (Updated structure)
            const order = {
                timestamp: new Date().toISOString(),
                userId: currentUserId,
                customer: {
                    name: employerName,
                    contact: contactNumber,
                },
                service: serviceData,
                workDetails: orderDetails, // Description only
                timeFrame: timeFrame, // Dedicated field
                budget: budget, // Dedicated field
                payment: {
                    depositConfirmed: depositPaid,
                    lastSixDigits: lastSixDigits,
                    receiptFile: document.getElementById('receiptUpload').files[0]?.name || 'No file selected'
                },
                status: 'QUOTE_REQUESTED'
            };

            // In a real application, you would save this 'order' object to a Firestore 'orders' collection.
            console.log("--- JOB ORDER SUBMITTED (SIMULATION) ---");
            console.log(JSON.stringify(order, null, 2));

            // Optional: Send a chat message to alert the admin of a new order
            if (isAuthReady && db) {
                const chatPath = `/artifacts/${appId}/public/data/chat_messages`;
                addDoc(collection(db, chatPath), {
                    userId: currentUserId,
                    userName: employerName,
                    text: `NEW JOB REQUEST submitted! Service: ${currentSection.toUpperCase()}. Last 6 Digits: ${lastSixDigits}.`,
                    timestamp: serverTimestamp(),
                    isAutomated: true // Flag for admin
                });
            }

            // 5. Final Confirmation
            showMessage("Job Request Submitted! The Admin has been notified in the chat. We will review your request and contact you soon.", 'success', 8000);
            
            // Clear form (except for contact details for convenience)
            document.getElementById('orderDetails').value = '';
            document.getElementById('timeFrame').value = ''; // Clear new field
            document.getElementById('budget').value = ''; // Clear new field
            document.getElementById('lastSixDigits').value = '';
            depositPaidEl.checked = false;
            receiptFieldsEl.classList.add('hidden');
        });

        // Initialize view on load
        window.onload = function() {
            showSection('typing');
            document.getElementById('designSize').dispatchEvent(new Event('change'));
        }

    </script>

    <!-- Global radio/checkbox styling -->
    <style>
        .radio-label {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
        }
        .radio-label:hover {
            border-color: var(--primary-light);
            background-color: #f1f5f9;
        }
        .radio-label input[type="radio"]:checked + span {
            color: var(--primary);
        }
        .radio-label input[type="radio"] {
            margin-right: 0.5rem;
            accent-color: var(--primary);
            width: 1rem;
            height: 1rem;
        }
    </style>

</body>
</html>
